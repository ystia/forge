#
# Ystia Forge
# Copyright (C) 2018 Bull S. A. S. - Bull, Rue Jean Jaures, B.P.68, 78340, Les Clayes-sous-Bois, France.
# Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
#
- name: Install ansible docker_image requirements
  hosts: all
  become: true
  tasks:
  - name: Get python version
    python_requirements_info:
    register: pri
    failed_when: pri == None or pri.python_version == None or pri.python_version == ''
  - name: Get python major version
    set_fact:
      python_major_version: "{{pri.python_version | replace('\n', '') | regex_replace('^(\\d+).*', '\\1') }}"
  - name: Install pip version compatible with python 2
    easy_install:
      name: pip<21.0
      state: latest  
    when: python_major_version == "2"
  - name: Install pip
    easy_install:
      name: pip
      state: latest  
    when: python_major_version != "2"
  - name: Get user defined at runtime
    set_fact:
      user_loading: "{{RUNTIME_USER}}"
    when: RUNTIME_USER != ""
  - name: Get user property
    set_fact:
      user_loading: "{{USER}}"
    when: RUNTIME_USER == ""
    failed_when: RUNTIME_USER == "" and USER == ""
  - name: Add to docker group
    user:
      name: "{{user_loading}}"
      groups: docker
      append: yes
    when: user_loading != "root"
  - name: Install 'docker' python package
    pip:
      name: docker
      # In user directory to avoid potential issues with distutils
      # see issue https://github.com/pypa/pip/issues/5247
      extra_args: --user
    become_user: "{{user_loading}}"
    become_method: sudo
  
