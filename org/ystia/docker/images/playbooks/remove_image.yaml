#
# Ystia Forge
# Copyright (C) 2020 Bull S. A. S. - Bull, Rue Jean Jaures, B.P.68, 78340, Les Clayes-sous-Bois, France.
# Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
#
- name: Remove Docker image
  hosts: all
  become: true
  tasks:
  # Trusting first REPO_TAGS returned by docker_image
  # if there is just one such image in the registry
  - name: "Get image {{NAME}} in regsitry"
    set_fact:
      images: "{{REPO_TAGS | from_json}}"
  - name: Get user defined at runtime
    set_fact:
      user_loading: "{{RUNTIME_USER}}"
    when: RUNTIME_USER != ""
  - name: Get user property
    set_fact:
      user_loading: "{{USER}}"
    when: RUNTIME_USER == ""
    failed_when: RUNTIME_USER == "" and USER == ""
  - name: "Remove image {{NAME}} {{TAG}}"
    docker_image:
      name: "{{images[0]}}"
      state: absent
    when: images | length == 1
    become_user: "{{user_loading}}"
    become_method: sudo
  - name: "Remove image {{NAME}} {{TAG}}"
    docker_image:
      name: "{{NAME}}"
      tag: "{{TAG}}"
      repository: "{{REPOSITORY}}"
      state: absent
    when: images | length != 1
    become_user: "{{user_loading}}"
    become_method: sudo
