#
# Ystia Forge
# Copyright (C) 2018 Bull S. A. S. - Bull, Rue Jean Jaures, B.P.68, 78340, Les Clayes-sous-Bois, France.
# Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
#

- name: Start Docker Container
  hosts: all
  become: true
  # When the container fails, go on to retrieve outputs
  vars:
    ansible_python_interpreter: "/usr/local/docker-py-env/bin/python"
    DOCKER_ENV: {}
    DOCKER_EXP_PORTS: []
    DOCKER_PUB_PORT: []
    DOCKER_VOLUMES: []
    DOCKER_STATE: "started"
  tasks:
  - name: Start container
    import_tasks: docker_container_tasks.yaml
    no_log: true
    ignore_errors: yes
  - name: Store container id (needed if it was directly started or config changed between create and start)
    set_fact:
      STARTED_CONTAINER_ID: "{{docker_res.ansible_facts.docker_container['Id']}}"
    when: docker_res.ansible_facts is defined
  - name: Get container output (truncated)
    debug:
      msg: "{{ docker_res.ansible_facts.docker_container.Output[-20000:] }}"
    when: not DETACH|bool and docker_res.ansible_facts is defined
  - name: Get error 
    debug:
      msg: "{{ docker_res.msg[-20000:] }}"
    when: docker_res.ansible_facts is not defined
  - name: Check status
    debug:
      msg: "Check container exit code"
    failed_when: docker_res.ansible_facts is not defined or docker_res.ansible_facts.docker_container.State.ExitCode != 0

